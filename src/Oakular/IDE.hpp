/**
 * @file IDE.hpp
 * @brief Oakular - Behavior tree editor with graphical node editing
 *
 * Copyright (c) 2025 Quentin Quadrat <lecrapouille@gmail.com>
 * distributed under MIT License
 */

#pragma once

#include "Application/Application.hpp"
#include "BlackThorn/BlackThorn.hpp"
#include "BlackThorn/Common/Signal.hpp"
#include "Server.hpp"

#include <imgui.h>

#include <map>
#include <memory>
#include <string>
#include <unordered_map>
#include <unordered_set>
#include <vector>

// Forward declarations
namespace YAML {
class Emitter;
class Node;
} // namespace YAML

class Renderer;

// ****************************************************************************
//! \brief brief Behavior tree editor application.
//!
//! - Editor: Create and edit behavior trees graphically
//! - Visualizer: Display runtime behavior trees from TCP clients
// ****************************************************************************
class IDE: public robotik::renderer::Application
{
    friend class Renderer;

public:

    //! \brief Type alias for node and link IDs
    using ID = int32_t;

    // ------------------------------------------------------------------------
    //! \brief Editor mode: Editor or Visualizer.
    //! - Editor: Create and edit behavior trees graphically.
    //! - Visualizer: Display runtime behavior trees from TCP clients.
    // ------------------------------------------------------------------------
    enum class Mode
    {
        Creation,  //!< Mode for creating trees graphically
        Visualizer //!< Mode for displaying in real-time a tree connected to a
                   //!< client
    };

    // ------------------------------------------------------------------------
    //! \brief Layout direction for displaying the tree.
    // ------------------------------------------------------------------------
    enum class LayoutDirection
    {
        LeftToRight = 0, //!< Layout direction from left to right
        TopToBottom = 1  //!< Layout direction from top to bottom
    };

    // ------------------------------------------------------------------------
    //! \brief Constructor.
    //! \param p_width Initial framebuffer width.
    //! \param p_height Initial framebuffer height.
    // ------------------------------------------------------------------------
    explicit IDE(size_t const p_width, size_t const p_height);

    // ------------------------------------------------------------------------
    //! \brief Destructor.
    // ------------------------------------------------------------------------
    virtual ~IDE();

private:

    // ------------------------------------------------------------------------
    //! \brief Link between nodes.
    // ------------------------------------------------------------------------
    struct Link
    {
        //! \brief Link ID
        ID id = 0;
        //! \brief From node ID
        ID from_node = 0;
        //! \brief To node ID
        ID to_node = 0;
    };

    // ------------------------------------------------------------------------
    //! \brief Graphical representation of a behavior tree node.
    // ------------------------------------------------------------------------
    struct Node
    {
        //! \brief Node ID
        ID id;
        //! \brief Node type ("Sequence", "Selector", etc.)
        std::string type;
        //! \brief User-defined name
        std::string name;
        //! \brief Node position
        ImVec2 position = ImVec2(0, 0);
        //! \brief Node children
        std::vector<ID> children;
        //! \brief Node parent
        ID parent = -1;
        //! \brief Blackboard input parameters
        std::vector<std::string> inputs;
        //! \brief Blackboard output parameters
        std::vector<std::string> outputs;
        //! \brief SubTree reference (for SubTree nodes)
        std::string subtree_reference;
        //! \brief SubTree expansion state
        bool is_expanded = false;
        //! \brief Optional: reference to actual BT node
        std::shared_ptr<bt::Node> bt_node;
        //! \brief Runtime status for visualizer mode (0=INVALID, 1=RUNNING,
        //! 2=SUCCESS, 3=FAILURE)
        int runtime_status = 0;
    };

    // ------------------------------------------------------------------------
    //! \brief Tree view for tab management
    // ------------------------------------------------------------------------
    struct TreeView
    {
        //! \brief Name of the tree view
        std::string name;
        //! \brief If the tree view is a subtree
        bool is_subtree;
        //! \brief Root node ID of the tree view
        ID root_id;
        //! \brief Layout direction for displaying the tree
        LayoutDirection layout_direction = LayoutDirection::TopToBottom;
        //! \brief Stored node positions for this view (node_id -> position)
        std::unordered_map<ID, ImVec2> node_positions;
    };

private: // Editor mode

    // ------------------------------------------------------------------------
    //! \brief Reset the editor.
    // ------------------------------------------------------------------------
    void reset();

    // ------------------------------------------------------------------------
    //! \brief Set the editor mode: Editor or Real-Time Visualizer.
    //! \param p_mode The new editor mode.
    // ------------------------------------------------------------------------
    void setMode(Mode const p_mode);

    // ------------------------------------------------------------------------
    //! \brief Node operations: add a new node to the tree.
    //! \param p_type The type of the node (e.g. "Action", "Condition",
    //! "Composite", "Decorator").
    //! \param p_name The name of the node.
    // ------------------------------------------------------------------------
    int addNode(std::string const& p_type, std::string const& p_name);

    // ------------------------------------------------------------------------
    //! \brief Add a node and link it to the pending link from node if any.
    //! \param p_type The type of the node.
    //! \param p_name The name of the node.
    // ------------------------------------------------------------------------
    void addNodeAndLink(std::string const& p_type, std::string const& p_name);

    // ------------------------------------------------------------------------
    //! \brief Delete a node from the tree.
    //! \param p_node_id The ID of the node to delete.
    // ------------------------------------------------------------------------
    void deleteNode(int const p_node_id);

    // ------------------------------------------------------------------------
    //! \brief Create a link between two nodes.
    void createLink(int const p_from_node, int const p_to_node);

    // ------------------------------------------------------------------------
    //! \brief Delete a link between two nodes.
    //! \param p_from_node The source node ID.
    //! \param p_to_node The target node ID.
    // ------------------------------------------------------------------------
    void deleteLink(int const p_from_node, int const p_to_node);

    // ------------------------------------------------------------------------
    //! \brief Load a tree from a YAML file.
    //! \param p_filepath The path to the YAML file.
    // ------------------------------------------------------------------------
    void loadFromYaml(std::string const& p_filepath);

    // ------------------------------------------------------------------------
    //! \brief Load a tree from a YAML string (for visualizer mode).
    //! \param p_yaml_content The YAML content as a string.
    // ------------------------------------------------------------------------
    void loadFromYamlString(std::string const& p_yaml_content);

    // ------------------------------------------------------------------------
    //! \brief Save a tree to a YAML file.
    //! \param p_filepath The path to the YAML file.
    // ------------------------------------------------------------------------
    void saveToYaml(std::string const& p_filepath);

    // ------------------------------------------------------------------------
    //! \brief Auto-layout the nodes in the tree.
    // ------------------------------------------------------------------------
    void autoLayoutNodes();

private: // Signals for synchronization

    //! \brief Signal emitted when a node is modified
    //! \param p_node_id The ID of the node that was modified
    robotik::Signal<ID> onNodeModified;
    //! \brief Signal emitted when a link is created
    //! \param p_from_node_id The ID of the from node
    //! \param p_to_node_id The ID of the to node
    robotik::Signal<ID, ID> onLinkCreated;
    //! \brief Signal emitted when a link is deleted
    //! \param p_link_id The ID of the link that was deleted
    robotik::Signal<ID> onLinkDeleted;

private: // Override methods from Application

    bool onSetup() override;
    void onTeardown() override;
    void onUpdate(float) override {}
    void onDrawMenuBar() override;
    void onDrawMainPanel() override;

private: // UI widgets

    void showAddNodePalette();
    void showNodeContextMenu();
    void showNodeEditPopup();
    void showQuitConfirmationPopup();
    void showVisualizerPanel();
    void showEditorTabs();
    void drawTreeTab(const std::string& name, TreeView& view);
    void showFileDialogs();
    void handleEditModeInteractions();
    void drawBehaviorTree();
    void handleKeyboardShortcuts();
    void showBlackboardPanel();

private: // TreeView helpers

    TreeView& getCurrentTreeView();
    TreeView* findTreeViewByRootId(ID root_id);
    Node* findNode(ID const p_id);

    // Helper functions to get/set node positions for current view
    ImVec2 getNodePosition(ID node_id);
    void setNodePosition(ID node_id, ImVec2 position);

    void layoutNodeRecursive(Node* p_node,
                             float p_x,
                             float p_y,
                             float& p_max_extent);

private: // SubTree management

    void toggleSubTreeExpansion(ID node_id);
    bool expandSubTree(Node* subtree_node);
    bool collapseSubTree(Node* subtree_node);
    void collectVisibleNodes(ID root_id, std::unordered_set<ID>& visible_nodes);

private: // Tree conversion

    void buildTreeFromNodes();
    void buildNodesFromTree(bt::Node& p_root);
    int buildNodesFromTreeRecursive(bt::Node& p_node, ID p_parent_id);
    void serializeNodeToYaml(YAML::Emitter& p_out,
                             Node* p_node,
                             bool is_subtree_definition = false);
    int parseYamlNode(const YAML::Node& p_yaml_node, ID p_parent_id);

private: // auto-increment unique identifiers

    inline ID getNextNodeId()
    {
        return m_unique_node_id++;
    }

private:

    //! \brief Mode: visualizer or editor.
    Mode m_mode = Mode::Creation;
    //! \brief Indicate how to render trees: from left to right or top to
    //! bottom.
    LayoutDirection m_layout_direction = LayoutDirection::TopToBottom;
    //! \brief Renderer for the tree.
    std::unique_ptr<Renderer> m_renderer;
    //! \brief Server for visualizing the client's running tree.
    std::unique_ptr<Server> m_server;
    //! \brief Modification flag for unsaved changes.
    bool m_is_modified = false;
    //! \brief Currently opened behavior tree file path.
    std::string m_behavior_tree_filepath;
    //! \brief Available tree views (name -> TreeView)
    std::map<std::string, TreeView> m_tree_views;
    //! \brief Nodes for all trees and subtrees.
    std::unordered_map<ID, Node> m_nodes;
    //! \brief Auto-incremented unique node ID.
    ID m_unique_node_id = 1;
    //! \brief Selected node ID.
    ID m_selected_node_id = -1;
    //! \brief Active tree view name
    std::string m_active_tree_name;
    //! \brief Flag to request programmatic tab change (used once then reset)
    bool m_request_tab_change = false;
    //! \brief Pending link creation from drag-drop
    ID m_pending_link_from_node = -1;
    struct ShowPalettes
    {
        //! \brief Show the node creation palette.
        bool node_creation = false;
        //! \brief Show the node edition popup.
        bool node_edition = false;
        //! \brief Show the quit confirmation popup.
        bool quit_confirmation = false;
        //! \brief Position of the palette (screen coordinates).
        ImVec2 position;
        //! \brief Position for node creation (canvas coordinates).
        ImVec2 canvas_position;
    } m_show_palettes;
    //! \brief Blackboard for storing shared variables.
    std::shared_ptr<bt::Blackboard> m_blackboard;
    //! \brief Flag to show the blackboard panel.
    bool m_show_blackboard_panel = true;
    //! \brief DFS order of node IDs for visualizer mode (maps index -> node_id)
    std::vector<ID> m_dfs_node_order;
};